<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Licensing System</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #F3F4F6; color: #1E3A8A; margin: 0; }
        .container { max-width: 800px; margin: 2rem auto; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; }
        h2 { text-align: center; margin-top: 1rem; }
        form { display: flex; flex-direction: column; gap: 1rem; }
        input, button, select { padding: 0.5rem; }
        button { background: #10B981; color: white; border: none; cursor: pointer; }
        button:hover { background: #059669; }
        .error { color: red; text-align: center; }
        .success { color: green; text-align: center; }
        .button-container { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; justify-content: center; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .card-header { font-weight: bold; margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .card-body { margin-bottom: 0.5rem; }
        .card-footer { display: flex; justify-content: flex-end; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container" id="app">
        <h1>Login</h1>
        <div id="error" class="error"></div>
        <form hx-post="/api/auth/login/" hx-target="#app" hx-swap="innerHTML">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    </div>
    <script>
        // Store token globally
        let authToken = '';

        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.xhr.status === 200) {
                try {
                    const response = JSON.parse(event.detail.xhr.responseText);
                    if (response.token) {
                        // Login response
                        authToken = response.token;
                        localStorage.setItem('token', authToken);
                        showDashboard();
                    }
                } catch (e) {
                    // Handle non-JSON responses (like HTML)
                    // Continue with normal HTMX processing
                }
            } else {
                // Handle errors
                const errorEl = document.getElementById('error');
                if (errorEl) {
                    errorEl.innerText = 'Request failed: ' + (event.detail.xhr.statusText || 'Unknown error');
                }
            }
        });

        // Function to show the main dashboard
        function showDashboard() {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }

            document.getElementById('app').innerHTML = `
                <h1>Vehicle Licensing System</h1>
                <div class="button-container">
                    <button hx-get="/api/vehicles/" 
                            hx-headers='{"Authorization": "Token ${token}"}' 
                            hx-target="#content">
                        My Vehicles
                    </button>
                    <button onclick="showLicenses()">
                        My Licenses
                    </button>
                    <button hx-get="/api/offenses/" 
                            hx-headers='{"Authorization": "Token ${token}"}' 
                            hx-target="#content">
                        Traffic Offenses
                    </button>
                    <button hx-get="/api/fines/" 
                            hx-headers='{"Authorization": "Token ${token}"}' 
                            hx-target="#content">
                        My Fines
                    </button>
                    <button hx-get="/api/registrations/" 
                            hx-headers='{"Authorization": "Token ${token}"}' 
                            hx-target="#content">
                        Vehicle Registrations
                    </button>
                    <button hx-get="/api/payments/" 
                            hx-headers='{"Authorization": "Token ${token}"}' 
                            hx-target="#content">
                        Payment History
                    </button>
                    <button onclick="logout()">
                        Logout
                    </button>
                </div>
                <div id="content" class="content-area">
                    <h2>Welcome to the Vehicle Licensing System</h2>
                    <p>Use the buttons above to navigate through the system.</p>
                </div>
            `;
        }

        // Function to show licenses
        function showLicenses() {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }

            fetch('/api/licenses/', {
                headers: {
                    'Authorization': `Token ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const licenses = data.results || [];
                
                let html = `
                    <h2>My Licenses</h2>
                    <div id="license-message" class="success"></div>
                `;
                
                if (licenses.length === 0) {
                    html += `<p>You don't have any licenses yet.</p>`;
                } else {
                    html += `<div class="licenses-list">`;
                    
                    licenses.forEach(license => {
                        const expiryDate = new Date(license.expiry_date);
                        const isExpired = expiryDate < new Date();
                        const statusClass = isExpired ? 'error' : 'success';
                        
                        html += `
                            <div class="card">
                                <div class="card-header">
                                    <span>License #${license.license_number}</span>
                                    <span class="${statusClass}">${isExpired ? 'Expired' : 'Active'}</span>
                                </div>
                                <div class="card-body">
                                    <p><strong>Type:</strong> ${license.license_type}</p>
                                    <p><strong>Issued:</strong> ${new Date(license.issue_date).toLocaleDateString()}</p>
                                    <p><strong>Expires:</strong> ${expiryDate.toLocaleDateString()}</p>
                                    <p><strong>State:</strong> ${license.state}</p>
                                </div>
                                <div class="card-footer">
                                    <button onclick="showRenewLicenseForm('${license.id}')">
                                        Renew License
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
                
                html += `
                    <div class="button-container">
                        <button onclick="showNewLicenseForm()">
                            Apply for New License
                        </button>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('content').innerHTML = `
                    <h2>My Licenses</h2>
                    <div class="error">Error loading licenses: ${error.message}</div>
                `;
            });
        }

        // Function to show license renewal form
        function showRenewLicenseForm(licenseId) {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }

            fetch(`/api/licenses/${licenseId}/`, {
                headers: {
                    'Authorization': `Token ${token}`
                }
            })
            .then(response => response.json())
            .then(license => {
                // Calculate date one year from now
                const today = new Date();
                const oneYearFromNow = new Date(today);
                oneYearFromNow.setFullYear(today.getFullYear() + 1);
                
                const formattedDate = oneYearFromNow.toISOString().split('T')[0];
                const currentExpiry = new Date(license.expiry_date).toLocaleDateString();
                
                const html = `
                    <h2>Renew License</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <span>License #${license.license_number}</span>
                        </div>
                        <div class="card-body">
                            <p><strong>Current Expiry:</strong> ${currentExpiry}</p>
                            <p><strong>Status:</strong> ${license.status}</p>
                        </div>
                    </div>
                    
                    <form id="renewal-form">
                        <input type="hidden" id="license-id" value="${license.id}">
                        
                        <label for="new-expiry">New Expiry Date:</label>
                        <input type="date" id="new-expiry" name="new_expiry" 
                               value="${formattedDate}" min="${today.toISOString().split('T')[0]}" required>
                        
                        <label for="fee-paid">Fee Amount:</label>
                        <input type="number" id="fee-paid" name="fee_paid" 
                               value="50.00" min="0" step="0.01" required>
                        
                        <label for="transaction-id">Transaction ID:</label>
                        <input type="text" id="transaction-id" name="transaction_id" 
                               placeholder="Enter payment transaction ID" required>
                        
                        <div class="button-container">
                            <button type="button" onclick="submitLicenseRenewal()">
                                Complete Renewal
                            </button>
                            <button type="button" onclick="showLicenses()">
                                Cancel
                            </button>
                        </div>
                    </form>
                    
                    <div id="renewal-message" class="error"></div>
                `;
                
                document.getElementById('content').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('content').innerHTML = `
                    <h2>Renew License</h2>
                    <div class="error">Error loading license: ${error.message}</div>
                    <div class="button-container">
                        <button onclick="showLicenses()">Back to Licenses</button>
                    </div>
                `;
            });
        }

        // Function to submit license renewal
        function submitLicenseRenewal() {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }

            const licenseId = document.getElementById('license-id').value;
            const newExpiry = document.getElementById('new-expiry').value;
            const feePaid = document.getElementById('fee-paid').value;
            const transactionId = document.getElementById('transaction-id').value;
            
            // Format expiry date with time
            const expiryDate = new Date(newExpiry);
            expiryDate.setHours(23, 59, 59);
            
            const renewalData = {
                license: licenseId,
                new_expiry: expiryDate.toISOString(),
                fee_paid: parseFloat(feePaid),
                transaction_id: transactionId
            };
            
            fetch('/api/license-renewals/', {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(renewalData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json().then(data => {
                        const message = document.getElementById('renewal-message');
                        message.className = 'success';
                        message.textContent = 'License renewed successfully!';
                        
                        // Redirect back to licenses list after 2 seconds
                        setTimeout(showLicenses, 2000);
                    });
                } else {
                    return response.json().then(errors => {
                        const message = document.getElementById('renewal-message');
                        message.className = 'error';
                        message.textContent = Object.values(errors).flat().join(', ');
                    });
                }
            })
            .catch(error => {
                const message = document.getElementById('renewal-message');
                message.className = 'error';
                message.textContent = 'Error: ' + error.message;
            });
        }

        // Function to show new license application form
        function showNewLicenseForm() {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }

            // Fetch license types and states for dropdown options
            Promise.all([
                fetch('/api/license-types/', {
                    headers: { 'Authorization': `Token ${token}` }
                }).then(res => res.json()),
                
                fetch('/api/states/', {
                    headers: { 'Authorization': `Token ${token}` }
                }).then(res => res.json())
            ])
            .then(([licenseTypesData, statesData]) => {
                const licenseTypes = licenseTypesData.results || licenseTypesData;
                const states = statesData.results || statesData;
                
                // Calculate default expiry date (1 year from now)
                const today = new Date();
                const oneYearFromNow = new Date(today);
                oneYearFromNow.setFullYear(today.getFullYear() + 1);
                
                const formattedDate = oneYearFromNow.toISOString().split('T')[0];
                
                const html = `
                    <h2>Apply for New License</h2>
                    
                    <form id="new-license-form">
                        <label for="license-number">License Number:</label>
                        <input type="text" id="license-number" name="license_number" 
                               placeholder="Enter license number" required>
                        
                        <label for="license-type">License Type:</label>
                        <select id="license-type" name="license_type" required>
                            <option value="">Select license type</option>
                            ${licenseTypes.map(type => 
                                `<option value="${type.id}">${type.name} - $${type.fee}</option>`
                            ).join('')}
                        </select>
                        
                        <label for="state">State:</label>
                        <select id="state" name="state" required>
                            <option value="">Select state</option>
                            ${states.map(state => 
                                `<option value="${state.id}">${state.name}</option>`
                            ).join('')}
                        </select>
                        
                        <label for="expiry-date">Expiry Date:</label>
                        <input type="date" id="expiry-date" name="expiry_date" 
                               value="${formattedDate}" min="${today.toISOString().split('T')[0]}" required>
                        
                        <div class="button-container">
                            <button type="button" onclick="submitNewLicense()">
                                Submit Application
                            </button>
                            <button type="button" onclick="showLicenses()">
                                Cancel
                            </button>
                        </div>
                    </form>
                    
                    <div id="license-message" class="error"></div>
                `;
                
                document.getElementById('content').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('content').innerHTML = `
                    <h2>Apply for New License</h2>
                    <div class="error">Error loading form: ${error.message}</div>
                    <div class="button-container">
                        <button onclick="showLicenses()">Back to Licenses</button>
                    </div>
                `;
            });
        }

        // Function to submit new license application
        function submitNewLicense() {
            const token = localStorage.getItem('token');
            if (!token) {
                return;
            }

            const licenseNumber = document.getElementById('license-number').value;
            const licenseType = document.getElementById('license-type').value;
            const state = document.getElementById('state').value;
            const expiryDate = document.getElementById('expiry-date').value;
            
            // Format date with time
            const expiryDateTime = new Date(expiryDate);
            expiryDateTime.setHours(23, 59, 59);
            
            const licenseData = {
                license_number: licenseNumber,
                license_type: parseInt(licenseType),
                state: parseInt(state),
                expiry_date: expiryDateTime.toISOString()
            };
            
            fetch('/api/licenses/', {
                method: 'POST',
                headers: {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(licenseData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json().then(data => {
                        const message = document.getElementById('license-message');
                        message.className = 'success';
                        message.textContent = 'License application successful!';
                        
                        // Redirect back to licenses list after 2 seconds
                        setTimeout(showLicenses, 2000);
                    });
                } else {
                    return response.json().then(errors => {
                        const message = document.getElementById('license-message');
                        message.className = 'error';
                        message.textContent = Object.values(errors).flat().join(', ');
                    });
                }
            })
            .catch(error => {
                const message = document.getElementById('license-message');
                message.className = 'error';
                message.textContent = 'Error: ' + error.message;
            });
        }

        // Function to log out
        function logout() {
            localStorage.removeItem('token');
            authToken = '';
            
            document.getElementById('app').innerHTML = `
                <h1>Login</h1>
                <div id="error" class="error"></div>
                <form hx-post="/api/auth/login/" hx-target="#app" hx-swap="innerHTML">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
            `;
        }

        // Check if user is already logged in when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (token) {
                authToken = token;
                showDashboard();
            }
        });
    </script>
</body>
</html>